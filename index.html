<!DOCTYPE html>
<html>
<head>
  <title>Kupon Kullan</title>
  <meta charset="UTF-8">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <h2 id="status">Kod kontrol ediliyor...</h2>
  <button id="useButton" style="display:none; font-size:18px;">✅ KULLAN ve YOK ET</button>

  <script>
    // Firebase config
    var firebaseConfig = {
      apiKey: "AIzaSyCkF3WOKAj0dtZanC1pAMrnkL9iZe5Y8o",
      authDomain: "okveto-kupon.firebaseapp.com",
      projectId: "okveto-kupon",
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    var params = new URLSearchParams(window.location.search);
    var code = params.get("code");

    var status = document.getElementById("status");
    var button = document.getElementById("useButton");

    if (!code) {
      status.innerText = "❌ Kod belirtilmedi.";
    } else {
      var docRef = db.collection("tickets").doc(code);

      docRef.get().then(function(doc) {
        if (!doc.exists) {
          status.innerText = "❌ Geçersiz kupon kodu.";
        } else if (doc.data().used === true) {
          status.innerText = "⚠️ Bu kupon zaten kullanılmış.";
        } else {
          status.innerText = `🎉 Kupon geçerli: ${code}`;
          button.style.display = "inline-block";

          button.onclick = function() {
            if (confirm("Bu bileti kullanmak istediğinize emin misiniz?\nBu işlem geri alınamaz.")) {
              docRef.update({
                used: true,
                usedAt: new Date().toISOString()
              }).then(function() {
                status.innerText = "✅ Kupon başarıyla kullanıldı!";
                button.style.display = "none";
              });
            }
          };
        }
      }).catch(function(error) {
        console.error("Hata:", error);
        status.innerText = "⚠️ Firebase bağlantısında hata oluştu.";
      });
    }
  </script>
</body>
</html>
